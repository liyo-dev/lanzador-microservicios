<div class="launcher-page">
  <app-spinner *ngIf="loading"></app-spinner>

  <section class="launcher-shell app-surface" [class.disabled]="loading">
    <header class="launcher-header">
      <div>
        <h1 class="page-title">Lanzador de Microservicios</h1>
        <p class="page-subtitle">
          Selecciona los servicios que necesitas y arr√°ncalos en segundos.
        </p>
      </div>
      <div class="header-actions">
        <button class="ghost-btn" (click)="goToHome()" title="Inicio">
          <span class="emoji">üè†</span>
        </button>
        <button class="ghost-btn" (click)="goToUsers()" title="Usuarios Portal">
          <span class="emoji">üë•</span>
        </button>
        <button class="ghost-btn" (click)="goToConfig()" title="Configuraci√≥n">
          <span class="emoji">‚öôÔ∏è</span>
        </button>
      </div>
    </header>

    <div class="launcher-tabs">
      <div class="tab-buttons">
        <button
          class="tab-btn"
          [class.active]="selectedTab === 'angular'"
          (click)="selectedTab = 'angular'"
        >
          <img src="assets/logoAngular.png" alt="Angular" />
          <span>Angular</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="selectedTab === 'spring'"
          (click)="selectedTab = 'spring'"
        >
          <img src="assets/logoSpring.png" alt="Spring" />
          <span>Spring</span>
        </button>
      </div>

      <div class="group-actions" *ngIf="hasMicrosToShow()">
        <button class="ghost-btn" (click)="stopSelected()">üõë Parar seleccionados</button>
        <button class="primary-btn" (click)="startSelected()">üöÄ Arrancar seleccionados</button>
      </div>
    </div>

    <section class="launcher-body">
      <div class="body-header">
        <div>
          <h2>{{ selectedTab === 'angular' ? 'Fronts disponibles' : 'Servicios disponibles' }}</h2>
          <p>
            {{ selectedTab === 'angular'
              ? 'Selecciona los fronts que deseas arrancar. Puedes activar compatibilidad legacy por micro.'
              : 'Selecciona los servicios de backend que necesitas ejecutar.'
            }}
          </p>
        </div>
      </div>

      <div class="empty-state" *ngIf="!hasMicrosToShow()">
        <div class="empty-card">
          <div class="empty-icon">üì¶</div>
          <h3>No hay microservicios {{ selectedTab === 'angular' ? 'Angular' : 'Spring' }} configurados</h3>
          <p>Ve a la configuraci√≥n para agregar microservicios y establecer sus rutas.</p>
          <button class="primary-btn" (click)="goToConfig()">
            ‚öôÔ∏è Abrir configuraci√≥n
          </button>
        </div>
      </div>

      <div class="micro-grid" *ngIf="hasMicrosToShow()">
        <article class="micro-card" *ngFor="let micro of getDisplayedMicros()" [attr.data-key]="micro.key">
          <label class="micro-checkbox">
            <input type="checkbox" [(ngModel)]="micro.selected" />
            <span class="checkmark"></span>
            <span class="label">{{ micro.label }}</span>
          </label>

          <div class="status" [class.running]="micro.status === 'running'" [class.stopped]="micro.status === 'stopped'">
            {{ micro.status }}
          </div>

          <div class="git-panel">
            <div class="git-header">
              <div
                class="branch-pill"
                [class.warn]="gitState[repoKey(selectedTab, micro.key)]?.hasChanges"
                *ngIf="gitState[repoKey(selectedTab, micro.key)]?.branch"
              >
                <span class="dot"></span>
                {{ gitState[repoKey(selectedTab, micro.key)]?.branch }}
                <span class="badge" *ngIf="gitState[repoKey(selectedTab, micro.key)]?.hasChanges">Cambios locales</span>
              </div>
              <div class="branch-pill muted" *ngIf="gitState[repoKey(selectedTab, micro.key)]?.error">
                ‚ö†Ô∏è {{ gitState[repoKey(selectedTab, micro.key)]?.error }}
              </div>
              <button
                class="ghost-btn small"
                (click)="refreshGitInfo(micro, selectedTab)"
                [disabled]="gitState[repoKey(selectedTab, micro.key)]?.loading"
              >
                üîÑ Actualizar Git
              </button>
            </div>

            <div class="git-controls" *ngIf="!gitState[repoKey(selectedTab, micro.key)]?.error">
              <label class="branch-select">
                <span>Rama</span>
                <select
                  [(ngModel)]="gitSelections[repoKey(selectedTab, micro.key)]"
                  [disabled]="gitState[repoKey(selectedTab, micro.key)]?.loading"
                >
                  <option
                    *ngFor="let branch of gitState[repoKey(selectedTab, micro.key)]?.branches"
                    [value]="branch"
                  >
                    {{ branch }}
                  </option>
                </select>
              </label>

              <div class="git-buttons">
                <button
                  class="ghost-btn"
                  (click)="runGitAction('fetch', micro, selectedTab)"
                  [disabled]="gitState[repoKey(selectedTab, micro.key)]?.loading || gitActions[repoKey(selectedTab, micro.key)]"
                >
                  Fetch
                </button>
                <button
                  class="ghost-btn"
                  (click)="runGitAction('checkout', micro, selectedTab)"
                  [disabled]="gitState[repoKey(selectedTab, micro.key)]?.loading || gitActions[repoKey(selectedTab, micro.key)]"
                >
                  Cambiar rama
                </button>
                <button
                  class="primary-btn"
                  (click)="runGitAction('pull', micro, selectedTab)"
                  [disabled]="gitState[repoKey(selectedTab, micro.key)]?.loading || gitActions[repoKey(selectedTab, micro.key)]"
                >
                  Pull
                </button>
              </div>
            </div>

            <div
              class="git-status-banner"
              *ngIf="(gitStatuses[repoKey(selectedTab, micro.key)] || gitState[repoKey(selectedTab, micro.key)]?.hasChanges) && !gitState[repoKey(selectedTab, micro.key)]?.error"
              [class.success]="gitStatuses[repoKey(selectedTab, micro.key)]?.tone === 'success'"
              [class.loading]="gitStatuses[repoKey(selectedTab, micro.key)]?.tone === 'loading'"
              [class.warning]="!gitStatuses[repoKey(selectedTab, micro.key)]"
            >
              <div class="status-icon" [class.spinning]="gitStatuses[repoKey(selectedTab, micro.key)]?.tone === 'loading'">
                <span *ngIf="gitStatuses[repoKey(selectedTab, micro.key)]?.tone === 'loading'" class="spinner"></span>
                <span *ngIf="gitStatuses[repoKey(selectedTab, micro.key)]?.tone === 'success'">‚úÖ</span>
                <span *ngIf="!gitStatuses[repoKey(selectedTab, micro.key)]">‚ö†Ô∏è</span>
              </div>
              <div class="status-copy">
                <p>
                  {{
                    gitStatuses[repoKey(selectedTab, micro.key)]?.message
                      || 'Tienes cambios locales. Continuaremos siempre que Git no devuelva conflictos.'
                  }}
                </p>
              </div>
            </div>

            <div class="git-loading" *ngIf="gitState[repoKey(selectedTab, micro.key)]?.loading">
              <span class="dot"></span> Consultando Git...
            </div>
          </div>

          <div class="legacy-toggle" *ngIf="selectedTab === 'angular'">
            <label>
              <input type="checkbox" [(ngModel)]="micro.useLegacyProvider" />
              <span>Compatibilidad Node</span>
            </label>
          </div>
        </article>
      </div>

      <div *ngIf="showSuccessMessage && !loading" class="success-banner" #successMessage>
        ‚úÖ Todos los micros arrancaron correctamente.
      </div>
    </section>

    <section class="logs-card">
      <div class="logs-header">
        <div>
          <h3>Logs recientes</h3>
          <small *ngIf="logs.length > 0">{{ logs.length }} entradas | L√≠mite: {{ MAX_LOGS }}</small>
        </div>
        <div class="logs-actions">
          <button class="ghost-btn" (click)="toggleLogs()">
            {{ showLogs ? 'Ocultar logs' : 'Mostrar logs' }}
          </button>
          <button class="danger-btn" (click)="clearLogs()" *ngIf="showLogs && logs.length > 1" title="Limpiar logs manualmente">
            üóëÔ∏è Limpiar
          </button>
        </div>
      </div>

      <div *ngIf="showLogs" class="log-box" #logBox>
        <div class="log-line" *ngFor="let log of logs">{{ log }}</div>
      </div>
    </section>
  </section>

  <div class="git-dialog-backdrop" *ngIf="gitDialog?.open">
    <div class="git-dialog" [class.danger]="gitDialog?.tone === 'danger'" [class.success]="gitDialog?.tone === 'success'">
      <div class="dialog-icon">{{ gitDialog?.tone === 'danger' ? '‚ö†Ô∏è' : '‚úÖ' }}</div>
      <div class="dialog-copy">
        <h4>{{ gitDialog?.title }}</h4>
        <p>{{ gitDialog?.message }}</p>
      </div>
      <button class="primary-btn" (click)="closeGitDialog()">Entendido</button>
    </div>
  </div>
</div>
