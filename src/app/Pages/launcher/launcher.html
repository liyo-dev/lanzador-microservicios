<div class="launcher-page">
  @if (initialLoading) {
    <app-spinner [message]="'Inicializando...'"></app-spinner>
  }

  @if (loading) {
    <app-spinner [message]="loadingMessage"></app-spinner>
  }

  <section class="launcher-shell app-surface">
    <header class="launcher-header">
      <div>
        <h1 class="page-title">Lanzador de Microservicios</h1>
        <p class="page-subtitle">
          Selecciona los servicios que necesitas y arr√°ncalos.
        </p>
      </div>
      <div class="header-actions">
        <button class="ghost-btn" (click)="goToHome()" title="Inicio">
          <span class="emoji">üè†</span>
        </button>
        <button class="ghost-btn" (click)="goToUsers()" title="Usuarios Portal">
          <span class="emoji">üë•</span>
        </button>
        <button class="ghost-btn" (click)="goToPorts()" title="Gesti√≥n de Puertos">
          <span class="emoji">üîå</span>
        </button>
        <button class="ghost-btn" (click)="goToConfig()" title="Configuraci√≥n">
          <span class="emoji">‚öôÔ∏è</span>
        </button>
      </div>
    </header>

    <div class="launcher-tabs">
      <div class="tab-buttons">
        <button
          class="tab-btn"
          [class.active]="selectedTab === 'angular'"
          (click)="selectedTab = 'angular'"
        >
          <img src="assets/logoAngular.png" alt="Angular" />
          <span>Angular</span>
        </button>
        <button
          class="tab-btn"
          [class.active]="selectedTab === 'spring'"
          (click)="selectedTab = 'spring'"
        >
          <img src="assets/logoSpring.png" alt="Spring" />
          <span>Spring</span>
        </button>
      </div>

      @if (hasMicrosToShow()) {
        <div class="group-actions">
          <button class="ghost-btn" (click)="stopSelected()">üõë Parar seleccionados</button>
          <button class="primary-btn" (click)="startSelected()">üöÄ Arrancar seleccionados</button>
        </div>
      }
    </div>

    <section class="launcher-body">
      <div class="body-header">
        <div>
          <h2>{{ selectedTab === 'angular' ? 'Fronts disponibles' : 'Servicios disponibles' }}</h2>
          <p>
            {{ selectedTab === 'angular'
              ? 'Selecciona los fronts que deseas arrancar. Puedes activar compatibilidad legacy por micro.'
              : 'Selecciona los servicios de backend que necesitas ejecutar.'
            }}
          </p>
        </div>
      </div>

      @if (!hasMicrosToShow()) {
        <div class="empty-state">
          <div class="empty-card">
            <div class="empty-icon">üì¶</div>
            <h3>No hay microservicios {{ selectedTab === 'angular' ? 'Angular' : 'Spring' }} configurados</h3>
            <p>Ve a la configuraci√≥n para agregar microservicios y establecer sus rutas.</p>
            <button class="primary-btn" (click)="goToConfig()">
              ‚öôÔ∏è Abrir configuraci√≥n
            </button>
          </div>
        </div>
      }

      @if (hasMicrosToShow()) {
        <div class="micro-grid">
          @for (micro of getDisplayedMicros(); track micro.key) {
            <article class="micro-card" [attr.data-key]="micro.key">
              <label class="micro-checkbox">
                <input type="checkbox" [(ngModel)]="micro.selected" />
                <span class="checkmark"></span>
                <span class="label">{{ micro.label }}</span>
              </label>

              <div class="status" [class.running]="micro.status === 'running'" [class.stopped]="micro.status === 'stopped'">
                {{ micro.status }}
              </div>

              <div class="git-panel">
                <div class="git-header">
                  @if (getGitState(selectedTab, micro.key).error) {
                    <div class="branch-pill muted">
                      ‚ö†Ô∏è {{ getGitState(selectedTab, micro.key).error }}
                    </div>
                  } @else if (getGitState(selectedTab, micro.key).branch) {
                    <div
                      class="branch-pill"
                      [class.warn]="getGitState(selectedTab, micro.key).hasChanges"
                    >
                      <span class="dot"></span>
                      {{ getGitState(selectedTab, micro.key).branch }}
                      @if (getGitState(selectedTab, micro.key).hasChanges) {
                        <span class="badge">Cambios locales</span>
                      }
                    </div>
                  } @else {
                    <div class="branch-pill muted">
                      <span class="dot"></span>
                      Sin informaci√≥n Git
                    </div>
                  }
                  <button
                    class="ghost-btn small"
                    (click)="refreshGitInfo(micro, selectedTab)"
                    [disabled]="getGitState(selectedTab, micro.key).loading ?? false"
                  >
                    üîÑ Actualizar Git
                  </button>
                </div>

                @if (!getGitState(selectedTab, micro.key).error) {
                  <div class="git-controls">
                    <label class="branch-select">
                      <span>Rama</span>
                      <select
                        [(ngModel)]="gitSelections[repoKey(selectedTab, micro.key)]"
                        [disabled]="getGitState(selectedTab, micro.key).loading ?? false"
                      >
                        @for (branch of getGitState(selectedTab, micro.key).branches; track branch) {
                          <option [value]="branch">
                            {{ branch }}
                          </option>
                        }
                      </select>
                    </label>

                    <div class="git-buttons">
                      <button
                        class="ghost-btn"
                        (click)="runGitAction('fetch', micro, selectedTab)"
                        [disabled]="(getGitState(selectedTab, micro.key).loading ?? false) || gitActions[repoKey(selectedTab, micro.key)]"
                      >
                        Fetch
                      </button>
                      <button
                        class="ghost-btn"
                        (click)="runGitAction('checkout', micro, selectedTab)"
                        [disabled]="(getGitState(selectedTab, micro.key).loading ?? false) || gitActions[repoKey(selectedTab, micro.key)]"
                      >
                        Cambiar rama
                      </button>
                      <button
                        class="primary-btn"
                        (click)="runGitAction('pull', micro, selectedTab)"
                        [disabled]="(getGitState(selectedTab, micro.key).loading ?? false) || gitActions[repoKey(selectedTab, micro.key)]"
                      >
                        Pull
                      </button>
                    </div>
                  </div>
                }

                @if (getGitState(selectedTab, micro.key).hasChanges && !getGitState(selectedTab, micro.key).error) {
                  <div class="git-hint">
                    ‚ö†Ô∏è Tienes cambios locales. Se te pedir√° confirmaci√≥n antes de descartarlos.
                  </div>
                }

                @if (getGitState(selectedTab, micro.key).loading) {
                  <div class="git-loading">
                    <span class="dot"></span> Consultando Git...
                  </div>
                }
              </div>

              @if (selectedTab === 'angular') {
                <div class="legacy-toggle">
                  <label class="toggle-switch">
                    <input type="checkbox" [(ngModel)]="micro.useLegacyProvider" />
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Compatibilidad Node</span>
                  </label>
                </div>
              }
            </article>
          }
        </div>
      }

      @if (showSuccessMessage && !loading) {
        <div class="success-banner" #successMessage>
          ‚úÖ Todos los micros arrancaron correctamente.
        </div>
      }
    </section>

    <section class="logs-card">
      <div class="logs-header">
        <div>
          <h3>Logs recientes</h3>
          @if (getActiveLogs().length > 0) {
            <small>{{ getActiveLogs().length }} entradas | L√≠mite: {{ MAX_LOGS }}</small>
          }
        </div>
        <div class="logs-actions">
          <button class="ghost-btn" (click)="toggleLogs()">
            {{ showLogs ? 'Ocultar logs' : 'Mostrar logs' }}
          </button>
          @if (showLogs && getActiveLogs().length > 1) {
            <button class="danger-btn" (click)="clearLogs()" title="Limpiar logs manualmente">
              üóëÔ∏è Limpiar
            </button>
          }
        </div>
      </div>

      @if (showLogs) {
        <!-- Pesta√±as de logs -->
        <div class="log-tabs">
          @for (tab of getLogTabs(); track tab.key) {
            <button 
              class="log-tab"
              [class.active]="selectedLogTab === tab.key"
              (click)="selectLogTab(tab.key)"
            >
              {{ tab.label }}
              <span class="tab-badge">{{ tab.count }}</span>
            </button>
          }
        </div>

        <div class="log-box" #logBox>
          @for (log of getActiveLogs(); track $index) {
            <div class="log-line">{{ log }}</div>
          }
          @if (getActiveLogs().length === 0) {
            <div class="log-line muted">No hay logs disponibles para esta pesta√±a</div>
          }
        </div>
      }
    </section>
  </section>

  @if (gitDialog?.open) {
    <div class="git-dialog-backdrop">
      <div class="git-dialog" 
           [class.danger]="gitDialog?.tone === 'danger'" 
           [class.success]="gitDialog?.tone === 'success'"
           [class.warning]="gitDialog?.tone === 'warning'">
        <div class="dialog-icon">
          {{ gitDialog?.tone === 'danger' ? '‚ö†Ô∏è' : gitDialog?.tone === 'warning' ? '‚ö†Ô∏è' : '‚úÖ' }}
        </div>
        <div class="dialog-copy">
          <h4>{{ gitDialog?.title }}</h4>
          <p>{{ gitDialog?.message }}</p>
        </div>
        @if (gitDialog?.type === 'confirm-checkout' || gitDialog?.type === 'confirm-pull') {
          <div class="dialog-actions">
            <button class="ghost-btn" (click)="closeGitDialog()">Cancelar</button>
            <button class="danger-btn" (click)="confirmGitDialog()">
              Descartar cambios y continuar
            </button>
          </div>
        } @else {
          <button class="primary-btn" (click)="closeGitDialog()">Entendido</button>
        }
      </div>
    </div>
  }
</div>
