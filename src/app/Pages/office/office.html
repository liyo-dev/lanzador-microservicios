<div class="office-page" [class.connected]="isConnected">
  <header class="office-header">
    <div class="header-main">
      <h1>Oficina Virtual</h1>
      <p>Mueve tu avatar con las flechas o WASD. Pulsa E cerca de alguien para interactuar.</p>
    </div>

    <div class="connection-status" [class]="connectionState">
      <span class="status-indicator"></span>
      <span>{{ connectionLabel }}</span>
    </div>

    <button type="button" class="exit-button" (click)="exitOffice()">Salir a la home</button>
  </header>

  <section class="join-panel app-surface" *ngIf="!isConnected">
    <h2>Personaliza tu llegada</h2>
    <p class="panel-description">
      Elige avatar, escribe tu nombre y entra a la oficina virtual del equipo.
    </p>

    <label class="form-field">
      <span>Nombre visible</span>
      <input
        type="text"
        maxlength="24"
        autocomplete="off"
        placeholder="Ej. Sara preparando releases"
        [(ngModel)]="displayName"
      />
    </label>

    <p class="server-hint">Te conectaremos automÃ¡ticamente a {{ serverUrl }}.</p>

    <div class="avatar-selection">
      <h3>Selecciona tu avatar</h3>
      <div class="avatar-grid">
        <button
          type="button"
          class="avatar-option"
          *ngFor="let avatar of avatars"
          (click)="selectAvatar(avatar)"
          [class.active]="avatar.id === selectedAvatar.id"
          [attr.aria-label]="avatar.label"
          [attr.title]="avatar.label"
        >
          <span class="avatar-emoji">{{ avatar.emoji }}</span>
        </button>
      </div>
    </div>

    <div class="avatar-preview">
      <div class="avatar-badge" [class]="'tone-' + selectedAvatar.tone">
        <span>{{ selectedAvatar.emoji }}</span>
      </div>
      <div>
        <h3>{{ previewName }}</h3>
        <p>AsÃ­ te verÃ¡ el resto en la oficina virtual.</p>
      </div>
    </div>

    <button type="button" class="join-button" (click)="joinOffice()" [disabled]="connectionState === 'connecting'">
      {{ connectionState === 'connecting' ? 'Conectandoâ€¦' : 'Entrar a la oficina' }}
    </button>

    <p class="error" *ngIf="connectionError">{{ connectionError }}</p>
  </section>

  <section class="office-stage" *ngIf="isConnected">
    <div class="workspace-wrapper">
      <div
        class="workspace"
        tabindex="0"
        [style.width.px]="space.width"
        [style.height.px]="space.height"
      >
        <div class="workspace-grid"></div>

        <div
          class="player"
          *ngFor="let player of players; trackBy: trackByPlayerId"
          [style.left.px]="player.x"
          [style.top.px]="player.y"
          [class.self]="player.id === selfId"
          [class.active]="isActiveTarget(player)"
        >
          <div
            class="speech-bubble"
            *ngIf="speechBubbles[player.id]"
            [class.broadcast]="speechBubbles[player.id]?.kind === 'broadcast'"
          >
            {{ speechBubbles[player.id]?.content }}
          </div>

          <div class="interact-hint" *ngIf="shouldShowInteractHint(player)">Pulsa E</div>

          <div class="player-avatar" [class]="'tone-' + player.avatar.tone">
            <span>{{ player.avatar.emoji }}</span>
          </div>
          <span class="player-name">{{ player.name }}</span>
        </div>
      </div>
    </div>

    <aside class="nearby-radar" *ngIf="nearbyPlayers.length">
      <h3>Personas cerca</h3>
      <ul>
        <li *ngFor="let player of nearbyPlayers; trackBy: trackByPlayerId" [class.active]="isActiveTarget(player)">
          <button type="button" (click)="openInteraction(player.id)">
            <span class="badge" [class]="'tone-' + player.avatar.tone">{{ player.avatar.emoji }}</span>
            <span>{{ player.name }}</span>
          </button>
        </li>
      </ul>
    </aside>

    <footer class="office-shortcuts" *ngIf="isConnected">
      <span>Atajos: E para interactuar con personas cercanas Â· Espacio abre el mensaje global</span>
      <button type="button" (click)="openBroadcast()">Abrir mensaje global</button>
    </footer>
  </section>

  <div class="interaction-overlay" *ngIf="interactionView && interactionView !== 'chat'">
    <div class="interaction-card" [ngSwitch]="interactionView">
      <ng-container *ngSwitchCase="'menu'">
        <header class="interaction-header" *ngIf="interactionTarget">
          <div class="avatar-badge" [class]="'tone-' + interactionTarget.avatar.tone">
            <span>{{ interactionTarget.avatar.emoji }}</span>
          </div>
          <div>
            <h2>{{ interactionTarget.name }}</h2>
            <p>Elige cÃ³mo quieres interactuar.</p>
          </div>
        </header>

        <div class="interaction-options">
          <button type="button" (click)="chooseInteraction('chat')">ðŸ’¬ Charlar</button>
          <button type="button" (click)="chooseInteraction('game')">ðŸŽ® Jugar</button>
          <button type="button" class="secondary" (click)="closeInteraction()">Cancelar</button>
        </div>
      </ng-container>

      <form *ngSwitchCase="'broadcast'" class="interaction-broadcast" (ngSubmit)="sendBroadcastMessage()">
        <header>
          <h2>Mensaje para toda la sala</h2>
          <button type="button" (click)="closeInteraction()">âœ•</button>
        </header>
        <input
          type="text"
          name="interactionBroadcast"
          autocomplete="off"
          placeholder="Comparte una actualizaciÃ³n con todo el equipo"
          [(ngModel)]="broadcastInput"
        />
        <div class="actions">
          <button type="submit" [disabled]="!broadcastInput.trim()">Compartir</button>
          <button type="button" class="secondary" (click)="interactionView = 'menu'">Volver</button>
        </div>
      </form>

      <div *ngSwitchCase="'game'" class="interaction-game">
        <header>
          <h2>Piedra, papel o tijeras con {{ interactionTarget?.name || 'tu oponente' }}</h2>
          <button type="button" (click)="closeInteraction()">âœ•</button>
        </header>

        <div class="game-scoreboard">
          <div class="score-card">
            <span class="label">TÃº</span>
            <strong>{{ miniGameState.playerScore }}</strong>
          </div>
          <div class="round-info">
            <span>Ronda {{ miniGameState.status === 'playing' ? miniGameState.round : miniGameState.history.length }}</span>
            <small>Mejor de 3</small>
          </div>
          <div class="score-card opponent">
            <span class="label">{{ interactionTarget?.name || 'Oponente' }}</span>
            <strong>{{ miniGameState.opponentScore }}</strong>
          </div>
        </div>

        <p *ngIf="miniGameState.status === 'playing'">
          Elige tu jugada. Quien consiga dos victorias se lleva la partida.
        </p>
        <p *ngIf="miniGameState.status === 'won'">ðŸŽ‰ Â¡Ganaste el duelo!</p>
        <p *ngIf="miniGameState.status === 'lost'">ðŸ˜… {{ interactionTarget?.name || 'Tu oponente' }} ganÃ³ esta vez.</p>

        <div class="last-round" *ngIf="miniGameLastRound as last">
          <span class="label">Ãšltima ronda</span>
          <span>{{ formatRpsMove(last.playerMove) }} vs {{ formatRpsMove(last.opponentMove) }} Â· {{ formatRpsOutcome(last.outcome) }}</span>
        </div>

        <div class="rps-options" *ngIf="miniGameState.status === 'playing'">
          <button type="button" *ngFor="let move of miniGameMoves" (click)="playMiniGame(move.id)">
            <span class="emoji">{{ move.emoji }}</span>
            <span>{{ move.label }}</span>
          </button>
        </div>

        <div class="actions">
          <button type="button" (click)="replayMiniGame()">
            {{ miniGameState.status === 'playing' ? 'Reiniciar' : 'Revancha' }}
          </button>
          <button type="button" class="secondary" (click)="interactionView = 'menu'">Volver</button>
        </div>
      </div>
    </div>
  </div>

  <form
    class="chat-composer"
    *ngIf="interactionView === 'chat' && interactionTarget"
    (ngSubmit)="sendChatMessage()"
  >
    <div class="chat-composer-header">
      <div class="chat-composer-avatar" [class]="'tone-' + interactionTarget.avatar.tone">
        <span>{{ interactionTarget.avatar.emoji }}</span>
      </div>
      <div class="chat-composer-meta">
        <strong>{{ interactionTarget.name }}</strong>
        <span>Mensaje privado</span>
      </div>
      <button type="button" class="chat-composer-close" (click)="closeInteraction()">âœ•</button>
    </div>

    <div class="chat-composer-input">
      <input
        type="text"
        name="interactionChat"
        autocomplete="off"
        placeholder="Escribe algo y pulsa Enter"
        [(ngModel)]="chatInput"
      />
      <button type="submit" [disabled]="!chatInput.trim()">Enviar</button>
    </div>
  </form>
</div>
