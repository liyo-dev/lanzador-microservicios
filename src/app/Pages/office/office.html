<div class="office-page" [class.connected]="isConnected">
  <header class="office-header">
    <div class="header-main">
      <h1>Oficina Virtual</h1>
      <p>Mueve tu avatar con las flechas o WASD. Pulsa E cerca de alguien para interactuar.</p>
    </div>

    <div class="connection-status" [class]="connectionState">
      <span class="status-indicator"></span>
      <span>{{ connectionLabel }}</span>
    </div>

    <button type="button" class="exit-button" (click)="exitOffice()">Salir a la home</button>
  </header>

  <section class="join-panel app-surface" *ngIf="!isConnected">
    <h2>Personaliza tu llegada</h2>
    <p class="panel-description">
      Elige avatar, escribe tu nombre y entra a la oficina virtual del equipo.
    </p>

    <label class="form-field">
      <span>Nombre visible</span>
      <input
        type="text"
        maxlength="24"
        autocomplete="off"
        placeholder="Ej. Sara preparando releases"
        [(ngModel)]="displayName"
      />
    </label>

    <p class="server-hint">Te conectaremos automÃ¡ticamente a {{ serverUrl }}.</p>

    <div class="avatar-selection">
      <h3>Selecciona tu avatar</h3>
      <div class="avatar-grid">
        <button
          type="button"
          class="avatar-option"
          *ngFor="let avatar of avatars"
          (click)="selectAvatar(avatar)"
          [class.active]="avatar.id === selectedAvatar.id"
          [attr.aria-label]="avatar.label"
          [attr.title]="avatar.label"
        >
          <span class="avatar-emoji">{{ avatar.emoji }}</span>
        </button>
      </div>
    </div>

    <div class="avatar-preview">
      <div class="avatar-badge" [class]="'tone-' + selectedAvatar.tone">
        <span>{{ selectedAvatar.emoji }}</span>
      </div>
      <div>
        <h3>{{ previewName }}</h3>
        <p>AsÃ­ te verÃ¡ el resto en la oficina virtual.</p>
      </div>
    </div>

    <button type="button" class="join-button" (click)="joinOffice()" [disabled]="connectionState === 'connecting'">
      {{ connectionState === 'connecting' ? 'Conectandoâ€¦' : 'Entrar a la oficina' }}
    </button>

    <p class="error" *ngIf="connectionError">{{ connectionError }}</p>
  </section>

  <section class="office-stage" *ngIf="isConnected">
    <div class="workspace-wrapper">
      <div
        class="workspace"
        tabindex="0"
        [style.width.px]="space.width"
        [style.height.px]="space.height"
      >
        <div class="workspace-grid"></div>

        <div
          class="player"
          *ngFor="let player of players; trackBy: trackByPlayerId"
          [style.left.px]="player.x"
          [style.top.px]="player.y"
          [class.self]="player.id === selfId"
          [class.active]="isActiveTarget(player)"
        >
          <div
            class="speech-bubble"
            *ngIf="speechBubbles[player.id]"
            [class.broadcast]="speechBubbles[player.id]?.kind === 'broadcast'"
          >
            {{ speechBubbles[player.id]?.content }}
          </div>

          <div class="mini-game-score" *ngIf="isMiniGameParticipant(player)">
            {{ miniGameScoreFor(player.id) ?? 0 }}
          </div>

          <div class="interact-hint" *ngIf="shouldShowInteractHint(player)">Pulsa E</div>

          <div class="player-avatar" [class]="'tone-' + player.avatar.tone">
            <span>{{ player.avatar.emoji }}</span>
          </div>
          <span class="player-name">{{ player.name }}</span>

          <div class="mini-game-choices" *ngIf="shouldShowMiniGameChoices(player)">
            <button
              type="button"
              *ngFor="let move of miniGameMoves"
              (click)="selectMiniGameMove(move.id)"
              [class.selected]="miniGameState.playerMove === move.id"
            >
              <span class="emoji">{{ move.emoji }}</span>
              <span>{{ move.label }}</span>
            </button>
            <p class="mini-game-choice-hint" *ngIf="miniGameState.playerMove as readyMove">
              Jugada lista: {{ formatRpsMove(readyMove) }}
            </p>
          </div>
        </div>

        <div class="mini-game-round-banner" *ngIf="isMiniGameActive()">
          {{ miniGameRoundLabel }}
        </div>

        <ng-container *ngIf="miniGameCountdownVisible() && miniGameCenterPosition() as countdownPos">
          <div class="mini-game-countdown" [style.left.px]="countdownPos.left" [style.top.px]="countdownPos.top">
            {{ miniGameCountdownLabel }}
          </div>
        </ng-container>

        <ng-container *ngIf="miniGameState.status === 'reveal'">
          <ng-container *ngIf="miniGameCenterPosition() as revealPos">
            <ng-container *ngIf="miniGameLastRound as last">
              <div class="mini-game-reveal" [style.left.px]="revealPos.left" [style.top.px]="revealPos.top + 56">
                <strong>{{ formatRpsOutcome(last.outcome) }}</strong>
              </div>
            </ng-container>
          </ng-container>
        </ng-container>

        <ng-container *ngIf="miniGameState.status === 'finished' && miniGameResultMessage as resultText">
          <ng-container *ngIf="miniGameCenterPosition() as resultPos">
            <div class="mini-game-result" [style.left.px]="resultPos.left" [style.top.px]="resultPos.top">
              <p>{{ resultText }}</p>
              <div class="actions">
                <button type="button" (click)="rematchMiniGame()">Revancha</button>
                <button type="button" class="secondary" (click)="closeMiniGame()">Cerrar</button>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>

    <aside class="nearby-radar" *ngIf="nearbyPlayers.length">
      <h3>Personas cerca</h3>
      <ul>
        <li *ngFor="let player of nearbyPlayers; trackBy: trackByPlayerId" [class.active]="isActiveTarget(player)">
          <button type="button" (click)="openInteraction(player.id)">
            <span class="badge" [class]="'tone-' + player.avatar.tone">{{ player.avatar.emoji }}</span>
            <span>{{ player.name }}</span>
          </button>
        </li>
      </ul>
    </aside>

    <footer class="office-shortcuts" *ngIf="isConnected">
      <span>Atajos: E para interactuar con personas cercanas Â· Espacio abre el mensaje global</span>
      <button type="button" (click)="openBroadcast()">Abrir mensaje global</button>
    </footer>
  </section>

  <div class="interaction-overlay" *ngIf="interactionView && interactionView !== 'chat'">
    <div class="interaction-card" [ngSwitch]="interactionView">
      <ng-container *ngSwitchCase="'menu'">
        <header class="interaction-header" *ngIf="interactionTarget">
          <div class="avatar-badge" [class]="'tone-' + interactionTarget.avatar.tone">
            <span>{{ interactionTarget.avatar.emoji }}</span>
          </div>
          <div>
            <h2>{{ interactionTarget.name }}</h2>
            <p>Elige cÃ³mo quieres interactuar.</p>
          </div>
        </header>

        <div class="interaction-options">
          <button type="button" (click)="chooseInteraction('chat')">ðŸ’¬ Charlar</button>
          <button type="button" (click)="chooseInteraction('game')">ðŸŽ® Jugar</button>
          <button type="button" class="secondary" (click)="closeInteraction()">Cancelar</button>
        </div>
      </ng-container>

      <form *ngSwitchCase="'broadcast'" class="interaction-broadcast" (ngSubmit)="sendBroadcastMessage()">
        <header>
          <h2>Mensaje para toda la sala</h2>
          <button type="button" (click)="closeInteraction()">âœ•</button>
        </header>
        <input
          type="text"
          name="interactionBroadcast"
          autocomplete="off"
          placeholder="Comparte una actualizaciÃ³n con todo el equipo"
          [(ngModel)]="broadcastInput"
        />
        <div class="actions">
          <button type="submit" [disabled]="!broadcastInput.trim()">Compartir</button>
          <button type="button" class="secondary" (click)="interactionView = 'menu'">Volver</button>
        </div>
      </form>
    </div>
  </div>

  <form
    class="chat-composer"
    *ngIf="interactionView === 'chat' && interactionTarget"
    (ngSubmit)="sendChatMessage()"
  >
    <div class="chat-composer-header">
      <div class="chat-composer-avatar" [class]="'tone-' + interactionTarget.avatar.tone">
        <span>{{ interactionTarget.avatar.emoji }}</span>
      </div>
      <div class="chat-composer-meta">
        <strong>{{ interactionTarget.name }}</strong>
        <span>Mensaje privado</span>
      </div>
      <button type="button" class="chat-composer-close" (click)="closeInteraction()">âœ•</button>
    </div>

    <div class="chat-composer-input">
      <input
        type="text"
        name="interactionChat"
        autocomplete="off"
        placeholder="Escribe algo y pulsa Enter"
        [(ngModel)]="chatInput"
      />
      <button type="submit" [disabled]="!chatInput.trim()">Enviar</button>
    </div>
  </form>
</div>
