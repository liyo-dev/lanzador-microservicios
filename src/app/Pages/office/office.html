<div class="office-page">
  <header class="office-header">
    <div class="header-main">
      <h1>Oficina Virtual</h1>
      <p>Mueve tu avatar con las flechas o WASD y conéctate con el resto del equipo.</p>
    </div>

    <div class="connection-status" [class]="connectionState">
      <span class="status-indicator"></span>
      <span>{{ connectionLabel }}</span>
    </div>

    <button type="button" class="exit-button" (click)="exitOffice()">Salir a la home</button>
  </header>

  <div class="office-layout" [class.connected]="isConnected">
    <section class="join-panel app-surface" *ngIf="!isConnected">
      <h2>Personaliza tu llegada</h2>
      <p class="panel-description">
        Elige avatar, escribe tu nombre y comparte la URL del servidor con tu equipo para estar en la misma sala.
      </p>

      <label class="form-field">
        <span>Nombre visible</span>
        <input
          type="text"
          maxlength="24"
          autocomplete="off"
          placeholder="Ej. Sara preparando releases"
          [(ngModel)]="displayName"
        />
      </label>

      <label class="form-field">
        <span>Servidor de la oficina</span>
        <input
          type="text"
          autocomplete="off"
          placeholder="ws://mi-servidor:8974"
          [(ngModel)]="serverUrl"
        />
      </label>

      <div class="avatar-selection">
        <h3>Selecciona tu avatar</h3>
        <div class="avatar-grid">
          <button
            type="button"
            class="avatar-option"
            *ngFor="let avatar of avatars"
            (click)="selectAvatar(avatar)"
            [class.active]="avatar.id === selectedAvatar.id"
          >
            <span class="avatar-emoji">{{ avatar.emoji }}</span>
            <span class="avatar-label">{{ avatar.label }}</span>
          </button>
        </div>
      </div>

      <div class="avatar-preview">
        <div class="avatar-badge" [class]="'tone-' + selectedAvatar.tone">
          <span>{{ selectedAvatar.emoji }}</span>
        </div>
        <div>
          <h3>{{ previewName }}</h3>
          <p>{{ selectedAvatar.description }}</p>
        </div>
      </div>

      <button type="button" class="join-button" (click)="joinOffice()" [disabled]="connectionState === 'connecting'">
        {{ connectionState === 'connecting' ? 'Conectando…' : 'Entrar a la oficina' }}
      </button>

      <p class="error" *ngIf="connectionError">{{ connectionError }}</p>
    </section>

    <section class="workspace-panel app-surface" *ngIf="isConnected">
      <header class="workspace-header">
        <div class="avatar-badge" [class]="'tone-' + selectedAvatar.tone">
          <span>{{ selectedAvatar.emoji }}</span>
        </div>
        <div>
          <h2>{{ previewName }}</h2>
          <p>Coordinando desde la estación virtual.</p>
        </div>
      </header>

      <div
        class="workspace"
        tabindex="0"
        [style.width.px]="space.width"
        [style.height.px]="space.height"
      >
        <div class="workspace-grid"></div>
        <div class="player"
          *ngFor="let player of players; trackBy: trackByPlayerId"
          [style.transform]="'translate(' + player.x + 'px,' + player.y + 'px)'"
          [class.self]="player.id === selfId"
        >
          <div class="player-avatar" [class]="'tone-' + player.avatar.tone">
            <span>{{ player.avatar.emoji }}</span>
          </div>
          <span class="player-name">{{ player.name }}</span>
        </div>
      </div>

      <aside class="nearby-panel" *ngIf="nearbyPlayers.length">
        <h3>Personas cerca</h3>
        <ul>
          <li *ngFor="let player of nearbyPlayers" [class.active]="player.id === activeConversationId">
            <button type="button" (click)="setActiveConversation(player.id)">
              <span class="badge" [class]="'tone-' + player.avatar.tone">{{ player.avatar.emoji }}</span>
              <span>{{ player.name }}</span>
            </button>
          </li>
        </ul>
      </aside>
    </section>

    <section class="chat-panel app-surface">
      <header class="chat-header">
        <div class="header-avatar" [class]="'tone-' + selectedAvatar.tone">
          <span>{{ selectedAvatar.emoji }}</span>
        </div>
        <div>
          <h2>Chat general</h2>
          <p>Comparte novedades con toda la oficina virtual.</p>
        </div>
      </header>

      <div class="chat-messages" #generalMessageList>
        <article
          class="chat-message"
          *ngFor="let message of generalMessages; trackBy: trackByMessageId"
          [class.system]="message.system"
          [class.self]="message.authorId === selfId"
        >
          <div class="message-avatar" [class]="'tone-' + message.avatar.tone">
            <span>{{ message.avatar.emoji }}</span>
          </div>
          <div class="message-content">
            <header>
              <span class="author">{{ message.authorName }}</span>
              <time>{{ message.createdAt | date: 'HH:mm' }}</time>
            </header>
            <p>{{ message.content }}</p>
          </div>
        </article>
      </div>

      <form class="chat-input" (ngSubmit)="sendGeneralMessage()">
        <input
          type="text"
          name="message"
          autocomplete="off"
          placeholder="Escribe un mensaje para el equipo..."
          [(ngModel)]="messageText"
          [disabled]="!isConnected"
        />
        <button type="submit" [disabled]="!messageText.trim() || !isConnected">Enviar</button>
      </form>
    </section>

    <section class="private-panel app-surface" *ngIf="isConnected">
      <header class="private-header">
        <h2>Chat cercano</h2>
        <p *ngIf="!activeConversation">Acércate a alguien para conversar en privado.</p>
        <div *ngIf="activeConversation" class="active-person">
          <span class="badge" [class]="'tone-' + activeConversation.avatar.tone">{{ activeConversation.avatar.emoji }}</span>
          <strong>{{ activeConversation.name }}</strong>
          <button type="button" (click)="clearConversation()">Cerrar</button>
        </div>
      </header>

      <div class="private-messages" #privateMessageList>
        <p class="empty" *ngIf="activeConversation && !(privateMessages[activeConversation.id]?.length)">
          Inicia la conversación con {{ activeConversation.name }}.
        </p>
        <article
          class="chat-message"
          *ngFor="let message of activeConversation ? privateMessages[activeConversation.id] : []; trackBy: trackByPrivateMessageId"
          [class.self]="message.fromId === selfId"
        >
          <div class="message-avatar" [class]="'tone-' + message.avatar.tone">
            <span>{{ message.avatar.emoji }}</span>
          </div>
          <div class="message-content">
            <header>
              <span class="author">{{ message.fromName }}</span>
              <time>{{ message.createdAt | date: 'HH:mm' }}</time>
            </header>
            <p>{{ message.content }}</p>
          </div>
        </article>
      </div>

      <form class="chat-input" (ngSubmit)="sendPrivateMessage()">
        <input
          type="text"
          autocomplete="off"
          placeholder="Envía un mensaje cercano"
          [(ngModel)]="privateMessageText"
          name="privateMessage"
          [disabled]="!activeConversation"
        />
        <button type="submit" [disabled]="!privateMessageText.trim() || !activeConversation">Enviar</button>
      </form>
    </section>
  </div>
</div>
