<div class="users-page">
  <section class="users-shell app-surface" [class.overlay-active]="showAddForm">
    <header class="users-header">
      <div class="title-block">
        <h1 class="page-title">
          GestiÃ³n de Usuarios Portal
        </h1>
        <p class="page-subtitle">
          Administra accesos rÃ¡pidos por entorno y ahorra tiempo al validar en el portal - {{ getCurrentEnvironment().name }}
        </p>
      </div>

      <div class="header-actions">
        <button class="ghost-btn" (click)="goToHome()" title="Ir al inicio">ğŸ </button>
        <button class="ghost-btn" (click)="goBack()" title="Volver al launcher">ğŸš€</button>
        <button class="ghost-btn" (click)="goToConfig()" title="Ir a configuraciÃ³n">âš™ï¸</button>
        <button class="primary-btn" (click)="showAddUserForm()">
          <span class="emoji">â•</span>
          AÃ±adir usuario
        </button>
      </div>
    </header>

    <div class="environment-tabs">
      @for (env of environments; track env.key) {
        <button
          class="env-tab"
          [class.active]="selectedEnvironment === env.key"
          (click)="switchEnvironment(env.key)"
          [attr.data-env]="env.key"
        >
          <span class="icon">{{ env.icon }}</span>
          <span class="name">{{ env.name }}</span>
          <span class="count">{{ getUserCountByEnvironment(env.key) }}</span>
        </button>
      }
    </div>

    @if (selectedEnvironment === 'local-dev') {
      <div class="sub-environment-switcher">
        <span class="label">Vista del portal:</span>
        <button
          class="sub-env"
          [class.active]="selectedSubEnvironment === 'local'"
          (click)="switchSubEnvironment('local')"
        >
          ğŸ  Local
        </button>
        <button
          class="sub-env"
          [class.active]="selectedSubEnvironment === 'dev'"
          (click)="switchSubEnvironment('dev')"
        >
          ğŸ”§ Desarrollo
        </button>
      </div>
    }

    @if (getUsersByEnvironment().length > 0) {
      <section class="users-content">
        @for (user of getUsersByEnvironment(); track user.id) {
          <article class="user-card" [attr.data-user-id]="user.id" [attr.data-env]="user.environment">
            <header>
              <div>
                <h3>{{ user.name }}</h3>
                <span class="env-badge" [attr.data-env]="user.environment">
                  @if (user.environment === 'local-dev') {
                    ğŸ ğŸ”§ LOCAL/DEV
                  }
                  @if (user.environment === 'pre') {
                    ğŸ§ª PRE
                  }
                </span>
              </div>
              <div class="card-actions">
                <button class="ghost-btn" (click)="editUser(user)" title="Editar usuario">âœï¸</button>
                <button class="ghost-btn danger" (click)="deleteUser(user.id)" title="Eliminar usuario">ğŸ—‘ï¸</button>
              </div>
            </header>

            <dl>
              <div>
                <dt>Grupo Emp</dt>
                <dd>{{ user.companyID || 'SCNP' }}</dd>
              </div>
              <div>
                <dt>Usuario</dt>
                <dd>{{ user.username }}</dd>
              </div>
              @if (user.description) {
                <div>
                  <dt>DescripciÃ³n</dt>
                  <dd>{{ user.description }}</dd>
                </div>
              }
              @if (user.environment === 'local-dev') {
                <div class="url-indicator">
                  <dt>URL Activa</dt>
                  <dd>
                    @if (selectedSubEnvironment === 'local') {
                      ğŸ  Local (localhost:8080)
                    }
                    @if (selectedSubEnvironment === 'dev') {
                      ğŸ”§ Dev (isban.dev.corp)
                    }
                  </dd>
                </div>
              }
            </dl>

            <div class="portal-actions">
              <!-- Login automÃ¡tico con Puppeteer -->
              <button 
                class="auto-login-btn" 
                (click)="loginWithUser(user)"
                title="Abre Chrome y completa el login automÃ¡ticamente con Puppeteer"
              >
                <span class="emoji">ğŸš€</span>
                Login
              </button>
            </div>
          </article>
        }
      </section>
    }

    @if (getUsersByEnvironment().length === 0) {
      <div class="empty-state">
        <div class="empty-card">
          <div class="icon">ğŸ‘¤</div>
          <h3>No hay usuarios configurados para {{ getCurrentEnvironment().name }}</h3>
          <p>AÃ±ade usuarios para acceder rÃ¡pidamente al portal en el entorno {{ getCurrentEnvironment().name }}</p>
          <button class="primary-btn" (click)="showAddUserForm()">
            <span class="emoji">â•</span>
            AÃ±adir usuario
          </button>
        </div>
      </div>
    }
  </section>

  @if (showAddForm) {
    <div class="form-overlay" (click)="cancelForm()">
      <div class="user-form" (click)="$event.stopPropagation()">
        <header>
          <h2>{{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
          <button class="ghost-btn" type="button" (click)="cancelForm()">âœ–ï¸</button>
        </header>

        <div class="form-grid">
          <label>
            <span>Entorno</span>
            <select [(ngModel)]="newUser.environment" [disabled]="!!editingUser">
              @for (env of environments; track env.key) {
                <option [value]="env.key">{{ env.icon }} {{ env.name }}</option>
              }
            </select>
            @if (!!editingUser) {
              <small>No se puede cambiar el entorno de un usuario existente.</small>
            }
          </label>

          <label>
            <span>Nombre del Usuario</span>
            <input 
              type="text" 
              [(ngModel)]="newUser.name" 
              placeholder="Ej: Test Raul"
              autocomplete="name"
              name="userDisplayName"
            />
          </label>

          <label>
            <span>Grupo Empresarial</span>
            <input 
              type="text" 
              [(ngModel)]="newUser.companyID" 
              placeholder="Ej: SCNP, TESTPORTAL"
              autocomplete="organization"
              name="companyID"
            />
            <small>Requerido para todos los entornos.</small>
          </label>

          <label>
            <span>Usuario</span>
            <input 
              type="text" 
              [(ngModel)]="newUser.username" 
              placeholder="Ej: Testraul"
              autocomplete="username"
              name="username"
            />
          </label>

          <label class="password-field">
            <span>ContraseÃ±a</span>
            <div class="password-input-wrapper">
              <input 
                [type]="showPassword ? 'text' : 'password'" 
                [(ngModel)]="newUser.password" 
                placeholder="ContraseÃ±a del usuario"
                autocomplete="current-password"
                name="password"
              />
              <button 
                type="button" 
                class="toggle-password-btn" 
                (click)="togglePasswordVisibility()"
                [title]="showPassword ? 'Ocultar contraseÃ±a' : 'Mostrar contraseÃ±a'"
              >
                {{ showPassword ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}
              </button>
            </div>
          </label>

          <label>
            <span>DescripciÃ³n (opcional)</span>
            <input 
              type="text" 
              [(ngModel)]="newUser.description" 
              placeholder="DescripciÃ³n del usuario"
              autocomplete="off"
              name="description"
            />
          </label>
        </div>

        <footer class="form-actions">
          <button class="ghost-btn" type="button" (click)="cancelForm()">Cancelar</button>
          <button class="primary-btn" type="button" (click)="saveUser()">
            <span class="emoji">ğŸ’¾</span>
            {{ editingUser ? 'Actualizar' : 'Guardar' }}
          </button>
        </footer>
      </div>
    </div>
  }
</div>
