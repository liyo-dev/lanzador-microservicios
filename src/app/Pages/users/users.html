<div class="users-page">
  <section class="users-shell app-surface" [class.overlay-active]="showAddForm">
    <header class="users-header">
      <div class="title-block">
        <h1 class="page-title">
          <span class="emoji">ğŸ‘¥</span>
          GestiÃ³n de Usuarios Portal
        </h1>
        <p class="page-subtitle">
          Administra accesos rÃ¡pidos por entorno y ahorra tiempo al validar en el portal - {{ getCurrentEnvironment().name }}
        </p>
      </div>

      <div class="header-actions">
        <button class="ghost-btn" (click)="goToHome()" title="Ir al inicio">ğŸ </button>
        <button class="ghost-btn" (click)="goBack()" title="Volver al launcher">ğŸš€</button>
        <button class="ghost-btn" (click)="goToConfig()" title="Ir a configuraciÃ³n">âš™ï¸</button>
        <button class="primary-btn" (click)="showAddUserForm()">
          <span class="emoji">â•</span>
          AÃ±adir usuario
        </button>
      </div>
    </header>

    <div class="environment-tabs">
      <button
        *ngFor="let env of environments"
        class="env-tab"
        [class.active]="selectedEnvironment === env.key"
        (click)="switchEnvironment(env.key)"
        [attr.data-env]="env.key"
      >
        <span class="icon">{{ env.icon }}</span>
        <span class="name">{{ env.name }}</span>
        <span class="count">{{ getUserCountByEnvironment(env.key) }}</span>
      </button>
    </div>

    <div class="sub-environment-switcher" *ngIf="selectedEnvironment === 'local-dev'">
      <span class="label">Vista del portal:</span>
      <button
        class="sub-env"
        [class.active]="selectedSubEnvironment === 'local'"
        (click)="switchSubEnvironment('local')"
      >
        ğŸ  Local
      </button>
      <button
        class="sub-env"
        [class.active]="selectedSubEnvironment === 'dev'"
        (click)="switchSubEnvironment('dev')"
      >
        ğŸ”§ Desarrollo
      </button>
    </div>

    <section class="users-content" *ngIf="getUsersByEnvironment().length > 0">
      <article class="user-card" *ngFor="let user of getUsersByEnvironment()" [attr.data-user-id]="user.id" [attr.data-env]="user.environment">
        <header>
          <div>
            <h3>{{ user.name }}</h3>
            <span class="env-badge" [attr.data-env]="user.environment">
              <ng-container *ngIf="user.environment === 'local-dev'">ğŸ ğŸ”§ LOCAL/DEV</ng-container>
              <ng-container *ngIf="user.environment === 'pre'">ğŸ§ª PRE</ng-container>
            </span>
          </div>
          <div class="card-actions">
            <button class="ghost-btn" (click)="editUser(user)" title="Editar usuario">âœï¸</button>
            <button class="ghost-btn danger" (click)="deleteUser(user.id)" title="Eliminar usuario">ğŸ—‘ï¸</button>
          </div>
        </header>

        <dl>
          <div>
            <dt>Grupo Emp</dt>
            <dd>{{ user.companyID || 'SCNP' }}</dd>
          </div>
          <div>
            <dt>Usuario</dt>
            <dd>{{ user.username }}</dd>
          </div>
          <div *ngIf="user.description">
            <dt>DescripciÃ³n</dt>
            <dd>{{ user.description }}</dd>
          </div>
          <div *ngIf="user.environment === 'local-dev'" class="url-indicator">
            <dt>URL Activa</dt>
            <dd>
              <ng-container *ngIf="selectedSubEnvironment === 'local'">ğŸ  Local (localhost:8080)</ng-container>
              <ng-container *ngIf="selectedSubEnvironment === 'dev'">ğŸ”§ Dev (isban.dev.corp)</ng-container>
            </dd>
          </div>
        </dl>

        <button class="primary-btn full-width" (click)="loginWithUser(user)" title="Abrir portal con este usuario">
          <span class="emoji">ğŸš€</span>
          Acceder al Portal
        </button>
      </article>
    </section>

    <div class="empty-state" *ngIf="getUsersByEnvironment().length === 0">
      <div class="empty-card">
        <div class="icon">ğŸ‘¤</div>
        <h3>No hay usuarios configurados para {{ getCurrentEnvironment().name }}</h3>
        <p>AÃ±ade usuarios para acceder rÃ¡pidamente al portal en el entorno {{ getCurrentEnvironment().name }}</p>
        <button class="primary-btn" (click)="showAddUserForm()">
          <span class="emoji">â•</span>
          AÃ±adir usuario
        </button>
      </div>
    </div>
  </section>

  <div class="form-overlay" *ngIf="showAddForm" (click)="cancelForm()">
    <div class="user-form" (click)="$event.stopPropagation()">
      <header>
        <h2>{{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
        <button class="ghost-btn" type="button" (click)="cancelForm()">âœ–ï¸</button>
      </header>

      <div class="form-grid">
        <label>
          <span>Entorno</span>
          <select [(ngModel)]="newUser.environment" [disabled]="!!editingUser">
            <option *ngFor="let env of environments" [value]="env.key">{{ env.icon }} {{ env.name }}</option>
          </select>
          <small *ngIf="!!editingUser">No se puede cambiar el entorno de un usuario existente.</small>
        </label>

        <label>
          <span>Nombre del Usuario</span>
          <input 
            type="text" 
            [(ngModel)]="newUser.name" 
            placeholder="Ej: Test Raul"
            autocomplete="name"
            name="userDisplayName"
          />
        </label>

        <label>
          <span>Grupo Empresarial</span>
          <input 
            type="text" 
            [(ngModel)]="newUser.companyID" 
            placeholder="Ej: SCNP, TESTPORTAL"
            autocomplete="organization"
            name="companyID"
          />
          <small>Requerido para todos los entornos.</small>
        </label>

        <label>
          <span>Usuario</span>
          <input 
            type="text" 
            [(ngModel)]="newUser.username" 
            placeholder="Ej: Testraul"
            autocomplete="username"
            name="username"
          />
        </label>

        <label>
          <span>ContraseÃ±a</span>
          <input 
            type="password" 
            [(ngModel)]="newUser.password" 
            placeholder="ContraseÃ±a del usuario"
            autocomplete="current-password"
            name="password"
          />
        </label>

        <label>
          <span>DescripciÃ³n (opcional)</span>
          <input 
            type="text" 
            [(ngModel)]="newUser.description" 
            placeholder="DescripciÃ³n del usuario"
            autocomplete="off"
            name="description"
          />
        </label>
      </div>

      <footer class="form-actions">
        <button class="ghost-btn" type="button" (click)="cancelForm()">Cancelar</button>
        <button class="primary-btn" type="button" (click)="saveUser()">
          <span class="emoji">ğŸ’¾</span>
          {{ editingUser ? 'Actualizar' : 'Guardar' }}
        </button>
      </footer>
    </div>
  </div>
</div>
