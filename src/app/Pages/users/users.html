<div class="users-container">
  <header class="page-header">
    <div class="header-top">
      <div class="header-content">
        <h1>
          <span class="icon">👥</span>
          Gestión de Usuarios Portal
        </h1>
        <p class="subtitle">Administra los usuarios para acceso automático al portal - {{ getCurrentEnvironment().name }}</p>
      </div>
      
      <div class="header-actions">
        <button class="nav-btn home-btn" (click)="goToHome()" title="Ir al inicio">
          🏠
        </button>
        <button class="nav-btn launcher-btn" (click)="goBack()" title="Volver al launcher">
          🚀
        </button>
        <button class="nav-btn config-btn" (click)="goToConfig()" title="Ir a configuración">
          ⚙️
        </button>
        <button class="btn btn-primary" (click)="showAddUserForm()">
          <span class="icon">➕</span>
          Añadir Usuario
        </button>
      </div>
    </div>
    
    <!-- Pestañas de entorno -->
    <div class="environment-tabs">
      <button 
        *ngFor="let env of environments"
        class="env-tab"
        [class.active]="selectedEnvironment === env.key"
        (click)="switchEnvironment(env.key)"
      >
        <span class="env-icon">{{ env.icon }}</span>
        <span class="env-name">{{ env.name }}</span>
        <span class="env-count">({{ getUserCountByEnvironment(env.key) }})</span>
      </button>
    </div>

    <!-- Sub-entorno switcher para Local/Dev cuando esté en local-dev -->
    <div class="sub-environment-switcher" *ngIf="selectedEnvironment === 'local-dev'">
      <div class="switcher-label">Vista:</div>
      <button 
        class="sub-env-btn"
        [class.active]="selectedSubEnvironment === 'local'"
        (click)="switchSubEnvironment('local')"
      >
        🏠 Local
      </button>
      <button 
        class="sub-env-btn"
        [class.active]="selectedSubEnvironment === 'dev'"
        (click)="switchSubEnvironment('dev')"
      >
        🔧 Desarrollo
      </button>
    </div>
  </header>

  <!-- Lista de usuarios filtrados por entorno -->
  <div class="users-grid" *ngIf="getUsersByEnvironment().length > 0">
    <div 
      class="user-card" 
      *ngFor="let user of getUsersByEnvironment()" 
      [attr.data-user-id]="user.id"
      [attr.data-env]="user.environment"
    >
      <div class="user-info">
        <h3 class="user-name">
          {{ user.name }}
          <span class="env-badge" [attr.data-env]="user.environment">
            <ng-container *ngIf="user.environment === 'local-dev'">
              🏠🔧 LOCAL/DEV
            </ng-container>
            <ng-container *ngIf="user.environment === 'pre'">
              🧪 PRE
            </ng-container>
          </span>
        </h3>
        <div class="user-details">
          <div class="detail-item">
            <span class="label">Grupo Emp:</span>
            <span class="value">{{ user.companyID || 'SCNP' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Usuario:</span>
            <span class="value">{{ user.username }}</span>
          </div>
          <div class="detail-item" *ngIf="user.description">
            <span class="label">Descripción:</span>
            <span class="value">{{ user.description }}</span>
          </div>
          <!-- Mostrar URL activa según el subentorno cuando esté en local-dev -->
          <div class="detail-item" *ngIf="user.environment === 'local-dev'">
            <span class="label">URL Activa:</span>
            <span class="value url-indicator">
              <ng-container *ngIf="selectedSubEnvironment === 'local'">
                🏠 Local (localhost:8080)
              </ng-container>
              <ng-container *ngIf="selectedSubEnvironment === 'dev'">
                🔧 Dev (isban.dev.corp)
              </ng-container>
            </span>
          </div>
        </div>
      </div>
      
      <div class="user-actions">
        <button 
          class="btn btn-success btn-login" 
          (click)="loginWithUser(user)"
          title="Abrir portal con este usuario"
        >
          <span class="icon">🚀</span>
          Acceder al Portal
        </button>
        
        <div class="action-buttons">
          <button 
            class="btn btn-outline btn-small" 
            (click)="editUser(user)"
            title="Editar usuario"
          >
            <span class="icon">✏️</span>
          </button>
          <button 
            class="btn btn-danger btn-small" 
            (click)="deleteUser(user.id)"
            title="Eliminar usuario"
          >
            <span class="icon">🗑️</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Estado vacío -->
  <div class="empty-state" *ngIf="getUsersByEnvironment().length === 0">
    <div class="empty-icon">👤</div>
    <h3>No hay usuarios configurados para {{ getCurrentEnvironment().name }}</h3>
    <p>Añade usuarios para acceder rápidamente al portal en el entorno {{ getCurrentEnvironment().name }}</p>
    <button class="btn btn-primary" (click)="showAddUserForm()">
      <span class="icon">➕</span>
      Añadir Usuario {{ getCurrentEnvironment().name }}
    </button>
  </div>

  <!-- Formulario de añadir/editar usuario -->
  <div class="form-overlay" *ngIf="showAddForm" (click)="cancelForm()">
    <div class="user-form" (click)="$event.stopPropagation()">
      <h2>
        <span class="icon">{{ editingUser ? '✏️' : '➕' }}</span>
        {{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}
      </h2>
      
      <div class="form-group">
        <label for="environment">Entorno</label>
        <select 
          id="environment"
          [(ngModel)]="newUser.environment" 
          class="form-control"
          [disabled]="!!editingUser"
        >
          <option *ngFor="let env of environments" [value]="env.key">
            {{ env.icon }} {{ env.name }}
          </option>
        </select>
        <small *ngIf="!!editingUser" class="form-help">
          No se puede cambiar el entorno de un usuario existente
        </small>
      </div>
      
      <div class="form-group">
        <label for="userName">Nombre del Usuario</label>
        <input 
          id="userName"
          type="text" 
          [(ngModel)]="newUser.name" 
          placeholder="Ej: Test Raul"
          class="form-control"
        >
      </div>
      
      <div class="form-group">
        <label for="companyID">Grupo Empresarial</label>
        <input 
          id="companyID"
          type="text" 
          [(ngModel)]="newUser.companyID" 
          placeholder="Ej: SCNP, TESTPORTAL"
          class="form-control"
        >
        <small class="form-help">Requerido para todos los entornos</small>
      </div>
      
      <div class="form-group">
        <label for="username">Usuario</label>
        <input 
          id="username"
          type="text" 
          [(ngModel)]="newUser.username" 
          placeholder="Ej: Testraul"
          class="form-control"
        >
      </div>
      
      <div class="form-group">
        <label for="password">Contraseña</label>
        <input 
          id="password"
          type="password" 
          [(ngModel)]="newUser.password" 
          placeholder="Contraseña del usuario"
          class="form-control"
        >
      </div>
      
      <div class="form-group">
        <label for="description">Descripción (opcional)</label>
        <input 
          id="description"
          type="text" 
          [(ngModel)]="newUser.description" 
          placeholder="Descripción del usuario"
          class="form-control"
        >
      </div>
      
      <div class="form-actions">
        <button class="btn btn-outline" (click)="cancelForm()">
          Cancelar
        </button>
        <button class="btn btn-primary" (click)="saveUser()">
          <span class="icon">💾</span>
          {{ editingUser ? 'Actualizar' : 'Guardar' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Navegación de entornos al pie de página -->
  <nav class="bottom-nav">
    <button 
      *ngFor="let env of environments" 
      [class.active]="selectedEnvironment === env.key"
      (click)="switchEnvironment(env.key)"
      class="env-btn"
      [attr.data-env]="env.key"
      [title]="'Cambiar a entorno ' + env.name"
    >
      <span class="icon">{{ env.icon }}</span>
      <span class="env-name">{{ env.name }}</span>
      <span class="user-count">({{ getUserCountByEnvironment(env.key) }})</span>
    </button>
  </nav>
</div>
